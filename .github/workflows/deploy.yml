# .github/workflows/deploy.yml
name: Build and Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # Azure Container Registry
  REGISTRY: ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}
  IMAGE_NAME: pricing-agent
  
  # Azure Container Apps
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  CONTAINER_APP_NAME: ${{ secrets.AZURE_CONTAINER_APP_NAME }}
  CONTAINER_APP_ENVIRONMENT: ${{ secrets.AZURE_CONTAINER_APP_ENVIRONMENT }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}
      
      - name: Extract version from commit
        id: version
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "VERSION=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "LATEST_TAG=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.version.outputs.IMAGE_TAG }}
            ${{ steps.version.outputs.LATEST_TAG }}
          cache-from: type=registry,ref=${{ steps.version.outputs.LATEST_TAG }}
          cache-to: type=inline
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: ${{ env.CONTAINER_APP_NAME }}
          containerAppEnvironment: ${{ env.CONTAINER_APP_ENVIRONMENT }}
          imageToDeploy: ${{ steps.version.outputs.IMAGE_TAG }}
          environmentVariables: |
            DAT_ORG_USERNAME=secretref:dat-org-username
            DAT_ORG_PASSWORD=secretref:dat-org-password
            DAT_USER_EMAIL=secretref:dat-user-email
            DAT_ORG_TOKEN_URL=secretref:dat-org-token-url
            DAT_USER_TOKEN_URL=secretref:dat-user-token-url
            DAT_RATE_LOOKUP_URL=secretref:dat-rate-lookup-url
            DAT_FORECAST_URL=secretref:dat-forecast-url
            GS_CLIENT_ID=secretref:gs-client-id
            GS_CLIENT_SECRET=secretref:gs-client-secret
            GS_AUTH_URL=secretref:gs-auth-url
            GOOGLE_MAPS_API_KEY=secretref:google-maps-api-key
            AZ_BLOB_ACCOUNT=secretref:az-blob-account
            AZ_BLOB_CONTAINER=secretref:az-blob-container
            AZ_BLOB_FILE=secretref:az-blob-file
            AZ_BLOB_KEY=secretref:az-blob-key
      
      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "Image: ${{ steps.version.outputs.IMAGE_TAG }}"
          echo "Container App: ${{ env.CONTAINER_APP_NAME }}"